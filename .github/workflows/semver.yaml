name: PR Quality & Version Preview

on:
  pull_request:
    types: [opened, edited, synchronize]

# üî• Permiss√µes essenciais para o bot comentar
permissions:
  pull-requests: write
  contents: read

jobs:
  validate-and-preview:
    runs-on: ubuntu-latest
    steps:
      # 1. Valida se o t√≠tulo segue o padr√£o Conventional Commits
      - name: Validate PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 2. Checkout para pegar as tags existentes
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 3. Calcula a vers√£o nova usando Javascript (Node)
      # Mais seguro que Bash para matem√°tica de vers√£o
      - name: Calculate Next Version
        id: calc_version
        uses: actions/github-script@v7
        with:
          script: |
            const semver = require('semver');
            const { execSync } = require('child_process');

            // 1. Pegar a √∫ltima tag (ou v0.0.0 se n√£o existir)
            let lastTag = 'v0.0.0';
            try {
              lastTag = execSync('git describe --tags --abbrev=0', { encoding: 'utf-8' }).trim();
            } catch (e) {
              console.log('Nenhuma tag encontrada, iniciando em v0.0.0');
            }
            
            // Limpa o 'v' se existir para o c√°lculo
            const cleanVersion = lastTag.replace(/^v/, '');
            
            // 2. Analisar o T√≠tulo do PR
            const prTitle = context.payload.pull_request.title;
            let bumpType = 'patch'; // Default para fix ou outros

            // L√≥gica de Conventional Commits no T√≠tulo
            if (prTitle.includes('!') || prTitle.includes('BREAKING CHANGE')) {
              bumpType = 'major';
            } else if (prTitle.startsWith('feat')) {
              bumpType = 'minor';
            }
            
            // 3. Calcular a nova vers√£o
            const nextVersion = semver.inc(cleanVersion, bumpType);
            
            console.log(`Vers√£o Atual: ${lastTag}`);
            console.log(`Tipo de Bump: ${bumpType}`);
            console.log(`Pr√≥xima Vers√£o: v${nextVersion}`);

            // Exportar para os pr√≥ximos steps
            core.setOutput('current_version', lastTag);
            core.setOutput('bump_type', bumpType);
            core.setOutput('next_version', `v${nextVersion}`);

      # 4. Comenta no PR (Atualiza se j√° existir)
      - name: Comment PR Version Preview
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ### üîÆ Previs√£o de Vers√£o
            
            | Atual | Mudan√ßa Detectada | **Nova Vers√£o Prevista** |
            | :---: | :---: | :---: |
            | `${{ steps.calc_version.outputs.current_version }}` | **${{ steps.calc_version.outputs.bump_type }}** | # **${{ steps.calc_version.outputs.next_version }}** # |
            
            > **Nota:** A vers√£o √© calculada baseada no t√≠tulo: `"${{ github.event.pull_request.title }}"`.
            > Se o c√°lculo parecer errado, verifique se o t√≠tulo segue o padr√£o [Conventional Commits](https://www.conventionalcommits.org/).
          comment_tag: version_preview
