name: PR Quality & Version Preview

on:
  pull_request:
    types: [opened, edited, synchronize]

# üî• Permiss√µes essenciais para o bot comentar
permissions:
  pull-requests: write
  contents: read

jobs:
  validate-and-preview:
    runs-on: ubuntu-latest
    steps:
      # 1. Valida se o t√≠tulo segue o padr√£o Conventional Commits
      - name: Validate PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 2. Checkout para pegar as tags existentes
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 3. Executa o seu script customizado
      - name: Calculate Next Version
        id: versioning # Definimos um ID para capturar a sa√≠da depois
        run: |
          # Aqui voc√™ executa seu script. 
          # Exemplo: ele deve dar um echo da vers√£o formatada para o GitHub Output
          chmod +x ./scripts/ci/get-next-version.sh
          NEXT_VER=$(./scripts/ci/get-next-version.sh)
          CURRENT_VER=$(git describe --tags --abbrev=0 || echo "0.0.0")
          
          # Salvando as vari√°veis para os pr√≥ximos steps
          echo "current_version=$CURRENT_VER" >> $GITHUB_OUTPUT
          echo "next_version=$NEXT_VER" >> $GITHUB_OUTPUT

      # 4. Comenta no PR (Atualiza se j√° existir)
      - name: Comment PR with Version Preview
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ## üöÄ Version Preview
            Analisei seu PR e aqui est√° o impacto previsto:
            
            - **Vers√£o Atual:** `${{ steps.versioning.outputs.current_version }}`
            - **Pr√≥xima Vers√£o:** `${{ steps.versioning.outputs.next_version }}`
            
            _Este coment√°rio foi gerado automaticamente pelo seu Pipeline de CI._
          comment_tag: version_preview 
          # Evita flood; ele edita o mesmo coment√°rio se o PR atualizar
